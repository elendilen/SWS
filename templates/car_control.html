<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è½¦è¿œç¨‹æ§åˆ¶</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
        }
        
        .video-section {
            flex: 2;
            min-width: 300px;
        }
        
        .video-container {
            position: relative;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .video-stream {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .control-section {
            flex: 1;
            min-width: 250px;
        }
        
        .control-panel {
            background-color: #ecf0f1;
            border-radius: 8px;
            padding: 20px;
        }
        
        .control-title {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: bold;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .control-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .btn-forward {
            background-color: #3498db;
            color: white;
            grid-column: 2;
        }
        
        .btn-left {
            background-color: #e74c3c;
            color: white;
            grid-column: 1;
            grid-row: 2;
        }
        
        .btn-stop {
            background-color: #95a5a6;
            color: white;
            grid-column: 2;
            grid-row: 2;
        }
        
        .btn-right {
            background-color: #e74c3c;
            color: white;
            grid-column: 3;
            grid-row: 2;
        }
        
        .btn-backward {
            background-color: #f39c12;
            color: white;
            grid-column: 2;
            grid-row: 3;
        }
        
        .photo-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .photo-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            background-color: #27ae60;
            color: white;
            min-width: 80px;
        }
        
        .photo-btn:hover {
            background-color: #2ecc71;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .photo-btn:active {
            transform: translateY(0);
        }
        
        .capture-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s ease;
        }
        
        .capture-flash.active {
            opacity: 0.8;
        }
        
        .status-panel {
            background-color: #34495e;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .status-value {
            font-weight: bold;
        }
        
        .status-online {
            color: #2ecc71;
        }
        
        .status-offline {
            color: #e74c3c;
        }
        
        .instructions {
            background-color: #d5dbdb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .instructions ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .reconnect-panel {
            background-color: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        
        .reconnect-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        
        .reconnect-btn:hover {
            background-color: #27ae60;
        }
        
        .reconnect-btn:active {
            background-color: #229954;
        }
        
        .reconnect-info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .system-info {
            background-color: #8e44ad;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .system-info h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .system-info .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .control-buttons {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .control-btn {
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— å°è½¦è¿œç¨‹æ§åˆ¶ç³»ç»Ÿ</h1>
            <p>å®æ—¶è§†é¢‘æµ + æ— çº¿æ§åˆ¶</p>
        </div>
        
        <div class="content">
            <div class="video-section">
                <div class="video-container">
                    <img src="{{ url_for('video_feed') }}" class="video-stream" alt="æ‘„åƒå¤´è§†é¢‘æµ">
                    <div class="video-overlay">
                        <span id="video-status">ğŸ“¹ è§†é¢‘æµå·²è¿æ¥</span>
                    </div>
                </div>
            </div>
            
            <div class="control-section">
                <div class="control-panel">
                    <div class="control-title">ğŸ® æ§åˆ¶é¢æ¿</div>
                    
                    <div class="control-buttons">
                        <button class="control-btn btn-forward" 
                                onmousedown="sendCommand('forward')" 
                                onmouseup="sendCommand('stop')"
                                ontouchstart="sendCommand('forward')" 
                                ontouchend="sendCommand('stop')">
                            â¬†ï¸<br>å‰è¿›
                        </button>
                        
                        <button class="control-btn btn-left" 
                                onmousedown="sendCommand('left')" 
                                onmouseup="sendCommand('stop')"
                                ontouchstart="sendCommand('left')" 
                                ontouchend="sendCommand('stop')">
                            â¬…ï¸<br>å·¦è½¬
                        </button>
                        
                        <button class="control-btn btn-stop" 
                                onclick="sendCommand('stop')">
                            â¹ï¸<br>åœæ­¢
                        </button>
                        
                        <button class="control-btn btn-right" 
                                onmousedown="sendCommand('right')" 
                                onmouseup="sendCommand('stop')"
                                ontouchstart="sendCommand('right')" 
                                ontouchend="sendCommand('stop')">
                            â¡ï¸<br>å³è½¬
                        </button>
                        
                        <button class="control-btn btn-backward" 
                                onmousedown="sendCommand('backward')" 
                                onmouseup="sendCommand('stop')"
                                ontouchstart="sendCommand('backward')" 
                                ontouchend="sendCommand('stop')">
                            â¬‡ï¸<br>åé€€
                        </button>
                    </div>
                    
                    <div class="photo-controls">
                        <button class="photo-btn" onclick="capturePhoto()">
                            ğŸ“¸<br>æ‹ç…§
                        </button>
                        <button class="photo-btn" onclick="openPhotos()">
                            ğŸ–¼ï¸<br>ç›¸å†Œ
                        </button>
                    </div>
                </div>
                
                <div class="status-panel">
                    <div class="status-item">
                        <span>å½“å‰å‘½ä»¤:</span>
                        <span class="status-value" id="current-cmd">S</span>
                    </div>
                    <div class="status-item">
                        <span>ä¸²å£è¿æ¥:</span>
                        <span class="status-value" id="serial-status">æ£€æŸ¥ä¸­...</span>
                    </div>
                    <div class="status-item">
                        <span>æ‘„åƒå¤´:</span>
                        <span class="status-value" id="camera-status">æ£€æŸ¥ä¸­...</span>
                    </div>
                    <div class="status-item">
                        <span>ç½‘ç»œè¿æ¥:</span>
                        <span class="status-value" id="network-status">æ£€æŸ¥ä¸­...</span>
                    </div>
                    <div class="status-item">
                        <span>ç³»ç»Ÿè¿è¡Œ:</span>
                        <span class="status-value" id="uptime">0ç§’</span>
                    </div>
                </div>
                
                <div class="reconnect-panel">
                    <button class="reconnect-btn" onclick="reconnectSerial()">
                        ğŸ”„ é‡è¿ä¸²å£
                    </button>
                    <div class="reconnect-info">
                        <span>é‡è¯•æ¬¡æ•°: </span>
                        <span class="status-value" id="retry-count">0</span>
                    </div>
                </div>
                
                <div class="instructions">
                    <h3>ğŸ“‹ æ“ä½œè¯´æ˜</h3>
                    <ul>
                        <li>ç‚¹å‡»æˆ–æŒ‰ä½æ–¹å‘æŒ‰é’®æ§åˆ¶å°è½¦</li>
                        <li>é‡Šæ”¾æŒ‰é’®æ—¶å°è½¦è‡ªåŠ¨åœæ­¢</li>
                        <li>åœæ­¢æŒ‰é’®å¯ç«‹å³åœæ­¢å°è½¦</li>
                        <li>æ”¯æŒè§¦æ‘¸å±æ“ä½œ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // é˜²æ­¢è§¦æ‘¸æ—¶çš„é»˜è®¤è¡Œä¸º
        document.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('control-btn')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('touchend', function(e) {
            if (e.target.classList.contains('control-btn')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // å‘é€æ§åˆ¶å‘½ä»¤ - ä¼˜åŒ–ç‰ˆæœ¬
        let commandQueue = [];
        let isProcessing = false;
        
        function sendCommand(command) {
            // å¦‚æœæ˜¯ç›¸åŒçš„å‘½ä»¤ï¼Œä¸é‡å¤å‘é€
            if (commandQueue.length > 0 && commandQueue[commandQueue.length - 1] === command) {
                return;
            }
            
            commandQueue.push(command);
            processCommandQueue();
        }
        
        function processCommandQueue() {
            if (isProcessing || commandQueue.length === 0) {
                return;
            }
            
            isProcessing = true;
            const command = commandQueue.shift();
            
            // æ·»åŠ è¶…æ—¶æ§åˆ¶
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 200); // 200msè¶…æ—¶
            
            fetch('/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ command: command }),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    document.getElementById('current-cmd').textContent = data.command;
                    console.log('å‘½ä»¤å·²å‘é€:', data.command);
                } else {
                    console.error('å‘½ä»¤å‘é€å¤±è´¥');
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    console.warn('è¯·æ±‚è¶…æ—¶:', command);
                } else {
                    console.error('è¯·æ±‚é”™è¯¯:', error);
                }
            })
            .finally(() => {
                isProcessing = false;
                // ç»§ç»­å¤„ç†é˜Ÿåˆ—ä¸­çš„å‘½ä»¤
                if (commandQueue.length > 0) {
                    setTimeout(processCommandQueue, 10);
                }
            });
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // æ›´æ–°å½“å‰å‘½ä»¤
                    document.getElementById('current-cmd').textContent = data.current_cmd;
                    
                    // æ›´æ–°ä¸²å£çŠ¶æ€
                    const serialStatus = document.getElementById('serial-status');
                    if (data.system_status && data.system_status.serial_connected) {
                        serialStatus.textContent = 'å·²è¿æ¥';
                        serialStatus.className = 'status-value status-online';
                    } else {
                        serialStatus.textContent = 'æœªè¿æ¥';
                        serialStatus.className = 'status-value status-offline';
                    }
                    
                    // æ›´æ–°æ‘„åƒå¤´çŠ¶æ€
                    const cameraStatus = document.getElementById('camera-status');
                    if (data.system_status && data.system_status.camera_active) {
                        cameraStatus.textContent = 'è¿è¡Œä¸­';
                        cameraStatus.className = 'status-value status-online';
                    } else {
                        cameraStatus.textContent = 'æœªæ¿€æ´»';
                        cameraStatus.className = 'status-value status-offline';
                    }
                    
                    // æ›´æ–°ç½‘ç»œçŠ¶æ€
                    const networkStatus = document.getElementById('network-status');
                    if (data.system_status && data.system_status.network_connected) {
                        networkStatus.textContent = 'å·²è¿æ¥';
                        networkStatus.className = 'status-value status-online';
                    } else {
                        networkStatus.textContent = 'æœªè¿æ¥';
                        networkStatus.className = 'status-value status-offline';
                    }
                    
                    // æ›´æ–°è¿è¡Œæ—¶é—´
                    const uptimeElement = document.getElementById('uptime');
                    if (data.system_status && data.system_status.uptime) {
                        const seconds = Math.floor(data.system_status.uptime);
                        const minutes = Math.floor(seconds / 60);
                        const hours = Math.floor(minutes / 60);
                        
                        let uptimeText = '';
                        if (hours > 0) {
                            uptimeText = `${hours}å°æ—¶${minutes % 60}åˆ†é’Ÿ`;
                        } else if (minutes > 0) {
                            uptimeText = `${minutes}åˆ†é’Ÿ${seconds % 60}ç§’`;
                        } else {
                            uptimeText = `${seconds}ç§’`;
                        }
                        uptimeElement.textContent = uptimeText;
                    }
                    
                    // æ›´æ–°é‡è¯•æ¬¡æ•°
                    const retryCountElement = document.getElementById('retry-count');
                    if (data.serial_status && data.serial_status.retry_count !== undefined) {
                        retryCountElement.textContent = data.serial_status.retry_count;
                    }
                })
                .catch(error => {
                    console.error('çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
                    // å½“æ— æ³•è·å–çŠ¶æ€æ—¶ï¼Œæ ‡è®°ä¸ºç¦»çº¿
                    document.getElementById('serial-status').textContent = 'è¿æ¥å¤±è´¥';
                    document.getElementById('serial-status').className = 'status-value status-offline';
                });
        }
        
        // é‡è¿ä¸²å£åŠŸèƒ½
        function reconnectSerial() {
            const btn = document.querySelector('.reconnect-btn');
            const originalText = btn.textContent;
            
            btn.textContent = 'ğŸ”„ é‡è¿ä¸­...';
            btn.disabled = true;
            
            fetch('/reconnect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    btn.textContent = 'âœ… é‡è¿æˆåŠŸ';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                } else {
                    btn.textContent = 'âŒ é‡è¿å¤±è´¥';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
                // ç«‹å³æ›´æ–°çŠ¶æ€
                updateStatus();
            })
            .catch(error => {
                console.error('é‡è¿å¤±è´¥:', error);
                btn.textContent = 'âŒ é‡è¿å¤±è´¥';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            });
        }
        
        // é”®ç›˜æ§åˆ¶æ”¯æŒ - ä¼˜åŒ–ç‰ˆæœ¬
        let pressedKeys = new Set();  // è·Ÿè¸ªå½“å‰æŒ‰ä¸‹çš„é”®
        let lastCommand = null;       // è·Ÿè¸ªæœ€åå‘é€çš„å‘½ä»¤
        
        document.addEventListener('keydown', function(e) {
            // ç©ºæ ¼é”®æ‹ç…§ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
            if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                capturePhoto();
                return;
            }
            
            // é˜²æ­¢é‡å¤è§¦å‘
            if (pressedKeys.has(e.key.toLowerCase())) {
                return;
            }
            
            let command = null;
            switch(e.key.toLowerCase()) {
                case 'w':
                case 'arrowup':
                    command = 'forward';
                    break;
                case 's':
                case 'arrowdown':
                    command = 'backward';
                    break;
                case 'a':
                case 'arrowleft':
                    command = 'left';
                    break;
                case 'd':
                case 'arrowright':
                    command = 'right';
                    break;
                case ' ':
                    command = 'stop';
                    e.preventDefault();
                    break;
            }
            
            if (command) {
                pressedKeys.add(e.key.toLowerCase());
                // åªæœ‰å½“å‘½ä»¤ä¸åŒæ—¶æ‰å‘é€
                if (lastCommand !== command) {
                    sendCommand(command);
                    lastCommand = command;
                }
            }
        });
        
        document.addEventListener('keyup', function(e) {
            const key = e.key.toLowerCase();
            pressedKeys.delete(key);
            
            // åªæœ‰å½“æ²¡æœ‰å…¶ä»–ç§»åŠ¨é”®æŒ‰ä¸‹æ—¶æ‰å‘é€åœæ­¢å‘½ä»¤
            switch(key) {
                case 'w':
                case 'arrowup':
                case 's':
                case 'arrowdown':
                case 'a':
                case 'arrowleft':
                case 'd':
                case 'arrowright':
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–ç§»åŠ¨é”®æŒ‰ä¸‹
                    if (!pressedKeys.has('w') && !pressedKeys.has('arrowup') &&
                        !pressedKeys.has('s') && !pressedKeys.has('arrowdown') &&
                        !pressedKeys.has('a') && !pressedKeys.has('arrowleft') &&
                        !pressedKeys.has('d') && !pressedKeys.has('arrowright')) {
                        sendCommand('stop');
                        lastCommand = 'stop';
                    }
                    break;
            }
        });
        
        // æ‹ç…§åŠŸèƒ½
        function capturePhoto() {
            // æ·»åŠ é—ªå…‰æ•ˆæœ
            const flash = document.createElement('div');
            flash.className = 'capture-flash active';
            document.body.appendChild(flash);
            
            // ç§»é™¤é—ªå…‰æ•ˆæœ
            setTimeout(() => {
                flash.remove();
            }, 200);
            
            // å‘é€æ‹ç…§è¯·æ±‚
            fetch('/capture_photo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage('æ‹ç…§æˆåŠŸï¼æ–‡ä»¶å: ' + data.filename, 'success');
                } else {
                    showMessage('æ‹ç…§å¤±è´¥: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('æ‹ç…§é”™è¯¯:', error);
                showMessage('æ‹ç…§å¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
            });
        }
        
        // æ‰“å¼€ç…§ç‰‡ç®¡ç†é¡µé¢
        function openPhotos() {
            window.open('/photos', '_blank');
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯å‡½æ•°
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            switch(type) {
                case 'success':
                    messageDiv.style.backgroundColor = '#27ae60';
                    break;
                case 'error':
                    messageDiv.style.backgroundColor = '#e74c3c';
                    break;
                default:
                    messageDiv.style.backgroundColor = '#3498db';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // é”®ç›˜å¿«æ·é”®è¯´æ˜
        function getCommandFromKey(key) {
            switch(key) {
                case 'w':
                case 'arrowup':
                    return 'forward';
                case 's':
                case 'arrowdown':
                    return 'backward';
                case 'a':
                case 'arrowleft':
                    return 'left';
                case 'd':
                case 'arrowright':
                    return 'right';
                default:
                    return null;
            }
        }
        
        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(updateStatus, 1000);
        
        // é¡µé¢åŠ è½½æ—¶ç«‹å³æ›´æ–°çŠ¶æ€
        updateStatus();
        
        // ç›‘å¬è§†é¢‘æµé”™è¯¯
        document.querySelector('.video-stream').addEventListener('error', function() {
            document.getElementById('video-status').textContent = 'ğŸ“¹ è§†é¢‘æµè¿æ¥å¤±è´¥';
        });
        
        document.querySelector('.video-stream').addEventListener('load', function() {
            document.getElementById('video-status').textContent = 'ğŸ“¹ è§†é¢‘æµå·²è¿æ¥';
        });
    </script>
</body>
</html>
